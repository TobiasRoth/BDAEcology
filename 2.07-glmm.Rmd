
# Generalized linear mixed models {#glmm}

## Introduction
THIS CHAPTER IS UNDER CONSTRUCTION!!! 
<!-- Steffis draft version, started 17.11.2021-->
In chapter \@ref(lmer) on linear mixed effect models we have introduced how to analyze metric outcome variables for which a normal distribution of residuals can be assumed (potentially after transformation), when the data have a hierarchical structure and, as a consequence, observations are not independent.
In chapter \@ref(glm)  on generalized linear models we have introduced how to analyze outcome variables for which a normal error distribution can not be assumed, as for example binary outcomes or count data. More precisely, we have extended modelling outcomes with normal error to modelling outcomes with error distributions from the exponential family (e.g., binomial or Poisson)
Generalized linear mixed models combine the two complexities. In this chapter, we will thus show how to analyze outcome variables with error distributions from the exponential family, when the data have a hierarchical structure. Remember, a hierarchical structure of the data means that the data are collected at different hierarchical levels (e.g. on smaller or larger units). Typically, the outcome variable is measured/observed at the lowest level but other variables may be measured at different levels. A first example is introduced in the next section.

<!-- Fragen an alle:
Wie nennen wir die y? Response, dependent variable, outcome, endpoint?
Fränzi: Outcome variable and predictors im alten Buch. Explanatory variables kam auch vor. Wir einigen uns auf outcome und predictors
-->

### Binomial Mixed Model

#### Background

```{r, echo=FALSE}

library(blmeco)
data(swallowfarms)

```

<!-- text from old book, slightly modified
https://bookdown.org/yihui/rmarkdown-cookbook/bibliography.html
Items can be cited directly within the documentation using the syntax @key where key is the citation key in the first line of the entry, e.g., @R-base. To put citations in parentheses, use [@key]. To cite multiple entries, separate the keys by semicolons, e.g., [@key-1; @key-2; @key-3]. To suppress the mention of the author, add a minus sign before @, e.g., [-@R-base].
-->
To illustrate the binomial mixed model we use a subset of a data set used by @Gruebler2010 on barn swallow *Hirundo rustica* nestling survival (we selected a nonrandom sample to be able to fit a simple model; hence, the results do not add unbiased knowledge about the swallow biology!). For `r nrow(swallowfarms)` swallow broods, we know the clutch size and the number of the nestlings that
fledged. The broods came from `r length(unique(swallowfarms$farm))` farms (larger unit), thus some of the farms had more than one brood. There are three predictors measured at the level of the farm: colony size (the number of swallow broods on that farm), cow (whether there are cows on the farm or not), and dung heap (the number of dung heaps, piles of cow dung, within 500 m of the farm).
The aim was to assess how swallows profit from insects that are attracted by livestock on the farm and by dung heaps. Broods from the same farm are not independent of each other because they represent a smaller unit which belongs to a larger unit (farm), and thus share the characteristics of the same larger unit: predictor variables were measured at the level of the farm, and are thus the same for all broods from a farm. We have to account for that when building the model by including farm as a random factor. The outcome variable consists of two values for each observation, as seen with the binomial model without random factors (Section 8.2.2): 
<!-- add correct chapter reference for GLM model -->
the number of chicks that fledged (successes) and the number of chicks that died  (failures), i.e., the clutch size minus number that fledged.
The random factor "farm" adds a farm-specific deviation $b_g$ to the intercept in the linear predictor. These deviations are modeled as normally distributed with mean $0$ and standard deviation $\sigma_g$.

\begin{eqnarray} 
y_i \sim Binom\left(p_i, n_i\right)\\
  (\#eq:y_binom)
logit\left(p_i\right) = \beta_0 + b_{g[i]} + \beta_1\;colonysize_i + \beta_2\;I\left(cow_i = 1\right) + \beta_3\;dungheap_i\\
  (\#eq:logit_p)
b_g \sim Norm\left(0, \sigma_g\right)
  (\#eq:b_g)
\end{eqnarray} 
<!-- You may refer to it using \@ref(eq:binom)-->


<!-- Frage an Fränzi: was war der Grund für das nonrandom sample? Könnte man das kurz erläutern? -->


```{r, inspect_data}

#-------------------------------------------------------------------------------
# Data on Barn Swallow (Hirundo rustica) nestling survival on farms
# Data is part of what was published in Grüebler et al. 2010, J Appl Ecol 47:1340-1347
# we selected the year 2003 and pairs with only one brood. We selected a non-random sample of the farms
# to be able to fit a simple model, thus the analysis serves only illustrative purposes!
# selected farms: 1001,1002,1004,1008,1010,1016,1019,1020,1021,1024,2102,2114,2117,2203,2204,2206,5102,5104,
# 5105,5307,7003,7004,7005,7007,7013,13005,13014,13016,15012,16002,16012,16017,16025,16036,16040,16041,16059,
# 17005,17009,18054,18057,18063,18064,18069,18124,18135,18145,18148,18155,18158,18165

# -------------------------------------------------------------------------------
library(blmeco)

# Fitting a Binomial mixed model in R
# A) using glmer function from lme4 package
#-------------------------------------------------------------------------------
data(swallowfarms)
dat <- swallowfarms
str(dat)
# n = 63 broods
# farm = ID of farm (= one colony), n_f=51 -> the random factor
# colsize = size of the colony (nr of breeding pairs)
# cow: 1 = there are cows (or other livestock) on the farm
# dung = number of dungheaps within 500 m of the nesting site (flies near dungheaps are a good source of food for the Swallow)
# colsize, cow and dung are variables measured at the level of the farm
# clutch = clutch size
# fledge = number of young fledged

# check number of farms in the data set
length(unique(dat$farm))

```

#### Fitting a Binomial Mixed Model in R

<!-- Steffis idea on 8.12.2021: use glmer first, then brms
- brms: https://bookdown.org/content/4857/
-->
To fit the model in R we start by using the function ```glmer``` from the R package ```lme4```. The glmer function uses the Laplace approximation, which is an analytic method to solve
integrals. This method is also often used in Bayesian statistics to obtain the posterior
distribution of parameters. We z-transform the covariates (subtraction of the
mean and division by the standard deviation so that the transformed variable
has a mean of 0 and a standard deviation of 1). This often facilitates
convergence of the model. 

```{r, prepare_data}

dat$colsize.z <- scale(dat$colsize)   # scaled values for better model convergence
dat$dung.z    <- scale(dat$dung)
dat$die <- dat$clutch - dat$fledge
dat$farm.f <- factor(dat$farm)     # for clarity we define farm as a factor to use it as the random factor

```

The glmer function uses the standard way to formulate a statistical model in R, with the outcome on the left, followed by the ```~``` symbol, meaning "explained by", followed by the predictors, which are separated by ```+```. The notation for the random factor with only a random intercept was introduced in chapter \@ref(lmer) and is ```(1|farm.f)``` here. When the model is fitted, you can inspect the summary of the model object, which provides the fitting method, the model formula, statistics for the model fit including the Akaike information criterion (AIC), the Bayesian information criterion (BIC), the scaled residuals, the random effects variance and information about observations and groups, a table with coefficient estimates for the fixed effects (with standard errors and a z-test for the coefficient) and correlations between fixed effects. We recommend to always check if the number of observations and groups, i.e., 63 barn swallow nests from 51 farms here, is correct. This information shows if the glmer function has correctly recognized the hierarchical structure in the data. Here, this is correct.

```{r, fit_model}

library(lme4)
mod.glmer <- glmer(cbind(fledge,die) ~ colsize.z + cow + dung.z + (1|farm.f) , data=dat, family="binomial")

# move to inference part.
summary(mod.glmer)
confint(mod.glmer)

```

#### Assessing Model Assumptions

```{r, assess_model_assumptions}

#-------------------------------------------------------------------------------
#9.1.3	Assessing model assumptions
#-------------------------------------------------------------------------------
# Figure 9.1
#-------------------------------------------------------------------------------

# STEFFI, 8.12.: hier weiter. Warum geht der Plot nicht? Ev. wie vorher mit jpg erstmals versuchen?
par(mfrow=c(2,2))    # check residuals
qqnorm(resid(mod.glmer), main="qq-plot residuals")
qqline(resid(mod.glmer))

qqnorm(ranef(mod.glmer)$farm.f[,1], main="qq-plot, farm")
qqline(ranef(mod.glmer)$farm.f[,1])

plot(fitted(mod.glmer), resid(mod.glmer)) # residuals vs fitted values
abline(h=0)

dat$fitted <- fitted(mod.glmer)
plot(dat$fitted,dat$fledge/dat$clutch)    # plot data vs. predicted values
abline(0,1)
#-------------------------------------------------------------------------------

mean(ranef(mod.glmer)$farm.f[,1])
t.should <- plogis(fixef(mod.glmer)["(Intercept)"])                # expected value at the intercept
t.is     <- plogis(fixef(mod.glmer)["(Intercept)"]-0.001690303)    # slightly reduced value because the mean farm random effect is not precisely 0
# => the error at the Intercept is:
(t.should-t.is)/t.should   # 0.09 %
# or:
exp(-0.001690303)
# the multiplicative factor on the odds (i.e. fledge/die) is about 0.2% too small



# check for overdispersion
dispersion_glmer(mod.glmer)

```


#### Drawing Conclusions

## Summary

<!-- Fragen an alle 
- Wenn wir auf ein Chapter, eine Figure oder einen Table referenzieren, wie schreiben wir das (gross, klein, ausgeschrieben, abgekürzt?)
- Wie wäre es, wenn ich glmm mit glmer und brms fitten würde? Um den Unterschied in der Inferenz zu zeigen?
-->







